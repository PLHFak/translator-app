<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traducteur Pro - EN ‚Üí FR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .api-config {
            background: #f0f9ff;
            border: 2px solid #0284c7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-config.configured {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .api-config-title {
            font-weight: 600;
            color: #0284c7;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-config.configured .api-config-title {
            color: #10b981;
        }

        .api-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="text"], input[type="password"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-save-api {
            padding: 10px 20px;
            background: #0284c7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-save-api:hover {
            background: #0369a1;
        }

        .api-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        .api-info a {
            color: #0284c7;
            text-decoration: none;
        }

        .api-info a:hover {
            text-decoration: underline;
        }

        .status {
            background: #f0f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ccc;
        }

        .status-indicator.active {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-start {
            background: #10b981;
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background: #059669;
        }

        .btn-start:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #ef4444;
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-stop:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .transcript-box {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
        }

        .transcript-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flag {
            font-size: 20px;
        }

        .transcript-text {
            color: #1f2937;
            line-height: 1.6;
            font-size: 15px;
        }

        .transcript-text.empty {
            color: #9ca3af;
            font-style: italic;
        }

        .settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-label {
            font-weight: 500;
            color: #374151;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        .info-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
            color: #92400e;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            margin-top: 10px;
            font-size: 14px;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .toggle-section {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            margin-top: 20px;
            padding: 10px;
            background: #f0f4f8;
            border-radius: 8px;
        }

        .toggle-section:hover {
            background: #e5e7eb;
        }

        .advanced-settings {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .advanced-settings.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Traducteur Pro Temps R√©el</h1>
        <p class="subtitle">Anglais ‚Üí Fran√ßais avec DeepL</p>

        <!-- API Configuration -->
        <div class="api-config" id="apiConfig">
            <div class="api-config-title">
                <span id="apiStatusIcon">üîë</span>
                <span id="apiStatusText">Configuration API DeepL</span>
            </div>
            <div class="api-input-row">
                <input 
                    type="password" 
                    id="deeplApiKey" 
                    placeholder="Cl√© API DeepL (optionnel - Free ou Pro)"
                    value=""
                />
                <button class="btn-save-api" onclick="saveApiKey()">
                    Sauvegarder
                </button>
            </div>
            <div class="api-info">
                üí° <strong>Sans cl√© API :</strong> Utilise une API gratuite (limit√©e, qualit√© r√©duite)<br>
                ‚ú® <strong>Avec DeepL :</strong> <a href="https://www.deepl.com/pro-api" target="_blank">Obtenir une cl√© gratuite</a> (500k caract√®res/mois gratuits)
            </div>
        </div>

        <div class="status">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Pr√™t √† d√©marrer</span>
        </div>

        <div class="controls">
            <button class="btn-start" id="startBtn" onclick="startListening()">
                ‚ñ∂Ô∏è D√©marrer l'√©coute
            </button>
            <button class="btn-stop" id="stopBtn" onclick="stopListening()" disabled>
                ‚èπÔ∏è Arr√™ter
            </button>
        </div>

        <div id="errorContainer"></div>

        <div>
            <div class="transcript-label">
                <span class="flag">üá¨üáß</span> D√©tect√© (Anglais)
            </div>
            <div class="transcript-box">
                <div class="transcript-text empty" id="englishText">
                    En attente de parole...
                </div>
            </div>
        </div>

        <div>
            <div class="transcript-label">
                <span class="flag">üá´üá∑</span> Traduction (Fran√ßais)
            </div>
            <div class="transcript-box">
                <div class="transcript-text empty" id="frenchText">
                    La traduction appara√Ætra ici...
                </div>
            </div>
        </div>

        <div class="settings">
            <div class="setting-row">
                <span class="setting-label">Voix fran√ßaise</span>
                <select id="voiceSelect">
                    <option value="">Chargement des voix...</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label">Vitesse de lecture</span>
                <select id="rateSelect">
                    <option value="0.8">Lent (0.8x)</option>
                    <option value="1" selected>Normal (1x)</option>
                    <option value="1.2">Rapide (1.2x)</option>
                    <option value="1.5">Tr√®s rapide (1.5x)</option>
                </select>
            </div>
        </div>

        <div class="toggle-section" onclick="toggleAdvanced()">
            <span id="toggleIcon">‚ñ∂Ô∏è</span>
            <span>Param√®tres avanc√©s</span>
        </div>

        <div class="advanced-settings" id="advancedSettings">
            <div class="setting-row">
                <span class="setting-label">D√©lai avant traduction</span>
                <select id="delaySelect">
                    <option value="500">0.5 seconde</option>
                    <option value="1000" selected>1 seconde</option>
                    <option value="1500">1.5 secondes</option>
                    <option value="2000">2 secondes</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label">Auto-lecture</span>
                <select id="autoSpeakSelect">
                    <option value="true" selected>Activ√©e</option>
                    <option value="false">D√©sactiv√©e</option>
                </select>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="translationCount">0</div>
                <div class="stat-label">Traductions</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="charCount">0</div>
                <div class="stat-label">Caract√®res</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgLatency">0ms</div>
                <div class="stat-label">Latence moy.</div>
            </div>
        </div>

        <div class="info-box">
            <strong>üí° Conseils d'utilisation :</strong>
            ‚Ä¢ Configure ta cl√© DeepL pour de meilleures traductions<br>
            ‚Ä¢ Autorise l'acc√®s au microphone quand demand√©<br>
            ‚Ä¢ Parle clairement en anglais<br>
            ‚Ä¢ Utilise des √©couteurs pour √©viter le feedback audio<br>
            ‚Ä¢ La traduction se lance automatiquement apr√®s une pause
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            deeplApiKey: localStorage.getItem('deeplApiKey') || '',
            translationDelay: 1000,
            autoSpeak: true
        };

        // Stats
        let stats = {
            translationCount: 0,
            totalChars: 0,
            latencies: []
        };

        // Speech Recognition
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let frenchVoices = [];
        let currentUtterance = null;
        let translationTimeout = null;
        let lastFinalTranscript = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeSpeechRecognition();
            loadVoices();
            updateApiStatus();
            
            // Load saved API key
            if (config.deeplApiKey) {
                document.getElementById('deeplApiKey').value = config.deeplApiKey;
            }
        });

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    console.log('Recognition started');
                    updateStatus('üé§ √âcoute active...', true);
                };

                recognition.onresult = async (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    const englishTextEl = document.getElementById('englishText');
                    
                    if (finalTranscript) {
                        const cleanTranscript = finalTranscript.trim();
                        englishTextEl.textContent = cleanTranscript;
                        englishTextEl.classList.remove('empty');
                        
                        // Avoid duplicate translations
                        if (cleanTranscript !== lastFinalTranscript) {
                            lastFinalTranscript = cleanTranscript;
                            scheduleTranslation(cleanTranscript);
                        }
                    } else if (interimTranscript) {
                        englishTextEl.textContent = interimTranscript + '...';
                        englishTextEl.classList.remove('empty');
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Recognition error:', event.error);
                    if (event.error === 'no-speech') {
                        if (isListening) {
                            setTimeout(() => {
                                if (isListening) recognition.start();
                            }, 100);
                        }
                    } else if (event.error === 'not-allowed') {
                        showError('Acc√®s au microphone refus√©. Autorise l\'acc√®s dans les param√®tres.');
                        stopListening();
                    } else {
                        updateStatus('‚ùå Erreur: ' + event.error, false);
                    }
                };

                recognition.onend = () => {
                    console.log('Recognition ended');
                    if (isListening) {
                        setTimeout(() => {
                            if (isListening) recognition.start();
                        }, 100);
                    } else {
                        updateStatus('‚è∏Ô∏è √âcoute arr√™t√©e', false);
                    }
                };
            } else {
                showError('Votre navigateur ne supporte pas la reconnaissance vocale. Utilisez Chrome ou Safari.');
            }
        }

        function scheduleTranslation(text) {
            // Clear existing timeout
            if (translationTimeout) {
                clearTimeout(translationTimeout);
            }

            // Schedule new translation
            const delay = parseInt(document.getElementById('delaySelect').value);
            translationTimeout = setTimeout(() => {
                translateAndSpeak(text);
            }, delay);
        }

        function loadVoices() {
            const voices = synthesis.getVoices();
            frenchVoices = voices.filter(voice => voice.lang.startsWith('fr'));
            
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';
            
            if (frenchVoices.length === 0) {
                voiceSelect.innerHTML = '<option value="">Aucune voix fran√ßaise trouv√©e</option>';
            } else {
                frenchVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.default || voice.lang === 'fr-FR') option.selected = true;
                    voiceSelect.appendChild(option);
                });
            }
        }

        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = loadVoices;
        }

        async function translateText(text) {
            const startTime = Date.now();
            
            try {
                if (config.deeplApiKey) {
                    // Use DeepL API
                    const formality = 'default'; // or 'more', 'less', 'prefer_more', 'prefer_less'
                    const url = config.deeplApiKey.endsWith(':fx') 
                        ? 'https://api-free.deepl.com/v2/translate'
                        : 'https://api.deepl.com/v2/translate';
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `DeepL-Auth-Key ${config.deeplApiKey}`,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'text': text,
                            'target_lang': 'FR',
                            'source_lang': 'EN',
                            'formality': formality
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`DeepL API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const latency = Date.now() - startTime;
                    updateStats(text.length, latency);
                    
                    return data.translations[0].text;
                } else {
                    // Fallback to MyMemory API
                    const response = await fetch(
                        `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|fr`
                    );
                    const data = await response.json();
                    
                    const latency = Date.now() - startTime;
                    updateStats(text.length, latency);
                    
                    if (data.responseStatus === 200 && data.responseData) {
                        return data.responseData.translatedText;
                    }
                    throw new Error('Translation failed');
                }
            } catch (error) {
                console.error('Translation error:', error);
                showError(`Erreur de traduction: ${error.message}`);
                return `[Erreur] ${text}`;
            }
        }

        async function translateAndSpeak(text) {
            const frenchTextEl = document.getElementById('frenchText');
            
            try {
                updateStatus('‚è≥ Traduction en cours...', true);
                
                const translatedText = await translateText(text);
                
                frenchTextEl.textContent = translatedText;
                frenchTextEl.classList.remove('empty');
                
                const autoSpeak = document.getElementById('autoSpeakSelect').value === 'true';
                if (autoSpeak) {
                    speakText(translatedText);
                }
                
                updateStatus('‚úÖ Traduction termin√©e', true);
                setTimeout(() => {
                    if (isListening) {
                        updateStatus('üé§ √âcoute active...', true);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                frenchTextEl.textContent = 'Erreur de traduction';
                showError(error.message);
            }
        }

        function speakText(text) {
            if (currentUtterance) {
                synthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            const voiceSelect = document.getElementById('voiceSelect');
            const rateSelect = document.getElementById('rateSelect');
            
            if (frenchVoices.length > 0 && voiceSelect.value !== '') {
                utterance.voice = frenchVoices[parseInt(voiceSelect.value)];
            }
            
            utterance.rate = parseFloat(rateSelect.value);
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onend = () => {
                currentUtterance = null;
            };

            utterance.onerror = (event) => {
                console.error('Speech error:', event);
                currentUtterance = null;
            };

            currentUtterance = utterance;
            synthesis.speak(utterance);
        }

        function startListening() {
            if (!recognition) {
                showError('La reconnaissance vocale n\'est pas disponible');
                return;
            }

            isListening = true;
            lastFinalTranscript = '';
            clearError();
            
            try {
                recognition.start();
            } catch (error) {
                console.error('Start error:', error);
                showError('Erreur au d√©marrage: ' + error.message);
                isListening = false;
                return;
            }
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            updateStatus('üé§ D√©marrage...', true);
        }

        function stopListening() {
            isListening = false;
            if (recognition) {
                recognition.stop();
            }
            if (currentUtterance) {
                synthesis.cancel();
            }
            if (translationTimeout) {
                clearTimeout(translationTimeout);
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus('‚è∏Ô∏è Arr√™t√©', false);
        }

        function saveApiKey() {
            const apiKey = document.getElementById('deeplApiKey').value.trim();
            config.deeplApiKey = apiKey;
            localStorage.setItem('deeplApiKey', apiKey);
            updateApiStatus();
            
            if (apiKey) {
                showSuccess('‚úÖ Cl√© API sauvegard√©e !');
            } else {
                showSuccess('‚ÑπÔ∏è Mode gratuit activ√©');
            }
        }

        function updateApiStatus() {
            const apiConfig = document.getElementById('apiConfig');
            const statusIcon = document.getElementById('apiStatusIcon');
            const statusText = document.getElementById('apiStatusText');
            
            if (config.deeplApiKey) {
                apiConfig.classList.add('configured');
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = 'DeepL configur√©';
            } else {
                apiConfig.classList.remove('configured');
                statusIcon.textContent = 'üîë';
                statusText.textContent = 'Mode gratuit (qualit√© limit√©e)';
            }
        }

        function updateStats(charCount, latency) {
            stats.translationCount++;
            stats.totalChars += charCount;
            stats.latencies.push(latency);
            
            document.getElementById('translationCount').textContent = stats.translationCount;
            document.getElementById('charCount').textContent = stats.totalChars;
            
            const avgLatency = stats.latencies.reduce((a, b) => a + b, 0) / stats.latencies.length;
            document.getElementById('avgLatency').textContent = Math.round(avgLatency) + 'ms';
        }

        function updateStatus(text, active) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            
            if (active) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">‚ö†Ô∏è ${message}</div>`;
            setTimeout(clearError, 5000);
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function showSuccess(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message" style="background: #d1fae5; border-color: #10b981; color: #065f46;">${message}</div>`;
            setTimeout(clearError, 3000);
        }

        function toggleAdvanced() {
            const settings = document.getElementById('advancedSettings');
            const icon = document.getElementById('toggleIcon');
            
            if (settings.classList.contains('show')) {
                settings.classList.remove('show');
                icon.textContent = '‚ñ∂Ô∏è';
            } else {
                settings.classList.add('show');
                icon.textContent = 'üîΩ';
            }
        }

        window.addEventListener('beforeunload', () => {
            stopListening();
        });
    </script>
</body>
</html>

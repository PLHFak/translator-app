<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traducteur Streaming - EN ‚Üí FR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .api-config {
            background: #f0f9ff;
            border: 2px solid #0284c7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-config.configured {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .api-config-title {
            font-weight: 600;
            color: #0284c7;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-config.configured .api-config-title {
            color: #10b981;
        }

        .api-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="text"], input[type="password"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-save-api {
            padding: 10px 20px;
            background: #0284c7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-save-api:hover {
            background: #0369a1;
        }

        .api-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        .api-info a {
            color: #0284c7;
            text-decoration: none;
        }

        .status {
            background: #f0f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ccc;
        }

        .status-indicator.active {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-start {
            background: #10b981;
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background: #059669;
        }

        .btn-start:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #ef4444;
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-stop:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .transcript-box {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            min-height: 120px;
            max-height: 180px;
            overflow-y: auto;
        }

        .transcript-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .flag {
            font-size: 20px;
        }

        .segment-count {
            font-size: 11px;
            color: #6b7280;
            font-weight: normal;
        }

        .transcript-text {
            color: #1f2937;
            line-height: 1.6;
            font-size: 15px;
        }

        .transcript-segment {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .transcript-text.empty {
            color: #9ca3af;
            font-style: italic;
        }

        .settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-label {
            font-weight: 500;
            color: #374151;
        }

        select, input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        input[type="number"] {
            width: 80px;
        }

        .info-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
            color: #92400e;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .processing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f59e0b;
            margin-left: 8px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .speaking-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            margin-left: 8px;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Traducteur Streaming</h1>
        <p class="subtitle">
            Anglais ‚Üí Fran√ßais avec DeepL
            <span class="badge">TEMPS R√âEL</span>
        </p>

        <!-- API Configuration -->
        <div class="api-config" id="apiConfig">
            <div class="api-config-title">
                <span id="apiStatusIcon">üîë</span>
                <span id="apiStatusText">Configuration API DeepL</span>
            </div>
            <div class="api-input-row">
                <input 
                    type="password" 
                    id="deeplApiKey" 
                    placeholder="Cl√© API DeepL (optionnel)"
                    value=""
                />
                <button class="btn-save-api" onclick="saveApiKey()">
                    Sauvegarder
                </button>
            </div>
            <div class="api-info">
                ‚ú® <strong>Avec DeepL :</strong> <a href="https://www.deepl.com/pro-api" target="_blank">Obtenir une cl√© gratuite</a> (500k caract√®res/mois)
            </div>
        </div>

        <div class="status">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Pr√™t √† d√©marrer</span>
            <span id="processingIndicator"></span>
            <span id="speakingIndicator"></span>
        </div>

        <div class="controls">
            <button class="btn-start" id="startBtn" onclick="startListening()">
                ‚ñ∂Ô∏è D√©marrer l'√©coute
            </button>
            <button class="btn-stop" id="stopBtn" onclick="stopListening()" disabled>
                ‚èπÔ∏è Arr√™ter
            </button>
        </div>

        <div id="errorContainer"></div>

        <div>
            <div class="transcript-label">
                <span><span class="flag">üá¨üáß</span> D√©tect√© (Anglais)</span>
                <span class="segment-count" id="segmentCount">0 segments</span>
            </div>
            <div class="transcript-box">
                <div class="transcript-text empty" id="englishText">
                    En attente de parole...
                </div>
            </div>
        </div>

        <div>
            <div class="transcript-label">
                <span><span class="flag">üá´üá∑</span> Traduction (Fran√ßais)</span>
                <span class="segment-count" id="translationCount">0 traductions</span>
            </div>
            <div class="transcript-box">
                <div class="transcript-text empty" id="frenchText">
                    La traduction appara√Ætra ici...
                </div>
            </div>
        </div>

        <div class="settings">
            <div class="setting-row">
                <span class="setting-label">Mots avant traduction</span>
                <input type="number" id="wordsBeforeTranslate" value="8" min="5" max="30">
            </div>
            <div class="setting-row">
                <span class="setting-label">Voix fran√ßaise</span>
                <select id="voiceSelect">
                    <option value="">Chargement...</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label">Vitesse de lecture</span>
                <select id="rateSelect">
                    <option value="0.9">Lent (0.9x)</option>
                    <option value="1">Normal (1x)</option>
                    <option value="1.1" selected>Rapide (1.1x)</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label">Hauteur de la voix</span>
                <select id="pitchSelect">
                    <option value="0.8">Grave (0.8x)</option>
                    <option value="0.9" selected>Un peu grave (0.9x)</option>
                    <option value="1">Normal (1x)</option>
                    <option value="1.1">Un peu aigu (1.1x)</option>
                    <option value="1.2">Aigu (1.2x)</option>
                </select>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="segmentsProcessed">0</div>
                <div class="stat-label">Segments</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="charCount">0</div>
                <div class="stat-label">Caract√®res</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgLatency">0ms</div>
                <div class="stat-label">Latence moy.</div>
            </div>
        </div>

        <div class="info-box">
            <strong>üí° Mode Streaming :</strong>
            ‚Ä¢ Traduction automatique tous les 8 mots (ou √† la fin d'une phrase)<br>
            ‚Ä¢ Lecture imm√©diate de la traduction<br>
            ‚Ä¢ √âcoute continue en parall√®le<br>
            ‚Ä¢ Parfait pour les conversations fluides !<br><br>
            <strong>üé§ Autoriser le microphone :</strong><br>
            Au premier clic sur "D√©marrer", une fen√™tre appara√Ætra. Clique sur <strong>"Autoriser"</strong> pour activer le micro.
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            deeplApiKey: localStorage.getItem('deeplApiKey') || '',
            wordsBeforeTranslate: 12
        };

        // Stats
        let stats = {
            segmentsProcessed: 0,
            totalChars: 0,
            latencies: []
        };

        // Speech components
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let frenchVoices = [];
        let currentUtterance = null;
        
        // Speech queue for streaming
        let speechQueue = [];
        let isSpeaking = false;

        // Streaming buffer
        let wordBuffer = [];
        let lastProcessedIndex = 0;
        let segmentHistory = [];
        let translationHistory = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeSpeechRecognition();
            loadVoices();
            updateApiStatus();
            checkMicrophonePermission();
            
            if (config.deeplApiKey) {
                document.getElementById('deeplApiKey').value = config.deeplApiKey;
            }
        });

        async function checkMicrophonePermission() {
            // Ne pas demander la permission au chargement, attendre le clic
            updateStatus('‚è∏Ô∏è Pr√™t √† d√©marrer', false);
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    console.log('Recognition started');
                    updateStatus('üé§ √âcoute active...', true);
                };

                recognition.onresult = async (event) => {
                    let currentTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            currentTranscript += transcript + ' ';
                        }
                    }

                    if (currentTranscript.trim()) {
                        await processStreamingTranscript(currentTranscript.trim());
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Recognition error:', event.error);
                    if (event.error === 'no-speech') {
                        // Pas de probl√®me, attend la parole
                        return;
                    } else if (event.error === 'aborted') {
                        // L'utilisateur a arr√™t√© manuellement
                        console.log('Recognition aborted by user');
                        return;
                    } else if (event.error === 'not-allowed') {
                        showError('‚ùå Microphone non autoris√©. Clique sur l\'ic√¥ne üîí dans la barre d\'adresse et autorise le microphone.');
                        stopListening();
                    } else if (event.error === 'network') {
                        showError('‚ùå Probl√®me de connexion r√©seau');
                    } else if (event.error === 'service-not-allowed') {
                        showError('‚ùå Service de reconnaissance vocale non disponible');
                        stopListening();
                    } else {
                        console.log('Error ignor√©:', event.error);
                        // Ne pas bloquer sur les erreurs mineures
                    }
                };

                recognition.onend = () => {
                    console.log('Recognition ended');
                    // Red√©marrer automatiquement seulement si on √©coute toujours
                    if (isListening) {
                        try {
                            recognition.start();
                        } catch (error) {
                            console.log('D√©j√† en cours, attente...');
                            setTimeout(() => {
                                if (isListening) {
                                    try {
                                        recognition.start();
                                    } catch (e) {
                                        console.log('Erreur red√©marrage:', e);
                                    }
                                }
                            }, 500);
                        }
                    }
                };
            } else {
                showError('Reconnaissance vocale non disponible. Utilisez Chrome ou Safari.');
            }
        }

        async function processStreamingTranscript(transcript) {
            // Add to buffer
            const words = transcript.split(' ');
            wordBuffer.push(...words);

            // Update display
            displayEnglishSegments();

            // Get threshold
            const threshold = parseInt(document.getElementById('wordsBeforeTranslate').value);

            // Check if we should translate
            const shouldTranslate = 
                wordBuffer.length >= threshold ||
                isSentenceEnd(transcript);

            if (shouldTranslate && wordBuffer.length > 0) {
                const textToTranslate = wordBuffer.join(' ');
                
                // Clear buffer
                wordBuffer = [];
                
                // Add to history
                segmentHistory.push(textToTranslate);
                updateSegmentCount();
                
                // Translate and speak
                await translateAndSpeakSegment(textToTranslate);
            }
        }

        function isSentenceEnd(text) {
            return /[.!?]$/.test(text.trim());
        }

        function displayEnglishSegments() {
            const englishTextEl = document.getElementById('englishText');
            
            let html = '';
            
            // Show processed segments
            segmentHistory.forEach((segment, index) => {
                html += `<div class="transcript-segment">${segment}</div>`;
            });
            
            // Show current buffer
            if (wordBuffer.length > 0) {
                html += `<div style="color: #6b7280; font-style: italic;">${wordBuffer.join(' ')}...</div>`;
            }
            
            if (html) {
                englishTextEl.innerHTML = html;
                englishTextEl.classList.remove('empty');
            } else {
                englishTextEl.innerHTML = 'En attente de parole...';
                englishTextEl.classList.add('empty');
            }
        }

        async function translateAndSpeakSegment(text) {
            showProcessing(true);
            
            try {
                const translatedText = await translateText(text);
                
                // Add to translation history
                translationHistory.push(translatedText);
                updateTranslationCount();
                
                // Display translations
                displayFrenchTranslations();
                
                // Speak immediately
                speakText(translatedText);
                
            } catch (error) {
                console.error('Translation error:', error);
                showError(`Erreur: ${error.message}`);
            } finally {
                showProcessing(false);
            }
        }

        function displayFrenchTranslations() {
            const frenchTextEl = document.getElementById('frenchText');
            
            let html = '';
            translationHistory.forEach((translation, index) => {
                html += `<div class="transcript-segment">${translation}</div>`;
            });
            
            if (html) {
                frenchTextEl.innerHTML = html;
                frenchTextEl.classList.remove('empty');
                
                // Auto-scroll to bottom
                frenchTextEl.scrollTop = frenchTextEl.scrollHeight;
            }
        }

        async function translateText(text) {
            const startTime = Date.now();
            
            try {
                if (config.deeplApiKey) {
                    const url = config.deeplApiKey.endsWith(':fx') 
                        ? 'https://api-free.deepl.com/v2/translate'
                        : 'https://api.deepl.com/v2/translate';
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `DeepL-Auth-Key ${config.deeplApiKey}`,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'text': text,
                            'target_lang': 'FR',
                            'source_lang': 'EN'
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error('Cl√© API DeepL invalide ou quota d√©pass√©');
                        } else if (response.status === 456) {
                            throw new Error('Quota de caract√®res d√©pass√© pour ce mois');
                        } else {
                            throw new Error(`Erreur DeepL (${response.status})`);
                        }
                    }

                    const data = await response.json();
                    const latency = Date.now() - startTime;
                    updateStats(text.length, latency);
                    
                    if (data.translations && data.translations[0]) {
                        return data.translations[0].text;
                    }
                    throw new Error('Format de r√©ponse DeepL invalide');
                } else {
                    // Fallback API
                    const response = await fetch(
                        `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|fr`,
                        { timeout: 10000 }
                    ).catch(() => { throw new Error('Pas de connexion internet'); });
                    
                    const data = await response.json();
                    const latency = Date.now() - startTime;
                    updateStats(text.length, latency);
                    
                    if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                        return data.responseData.translatedText;
                    }
                    throw new Error('Traduction √©chou√©e (API gratuite)');
                }
            } catch (error) {
                console.error('Translation error:', error);
                throw error;
            }
        }

        function speakText(text) {
            // Don't cancel ongoing speech, queue it instead
            const utterance = new SpeechSynthesisUtterance(text);
            const voiceSelect = document.getElementById('voiceSelect');
            const rateSelect = document.getElementById('rateSelect');
            const pitchSelect = document.getElementById('pitchSelect');
            
            if (frenchVoices.length > 0 && voiceSelect.value !== '') {
                utterance.voice = frenchVoices[parseInt(voiceSelect.value)];
            }
            
            utterance.rate = parseFloat(rateSelect.value);
            utterance.pitch = parseFloat(pitchSelect.value);
            utterance.volume = 1;
            
            // Queue management
            speechQueue.push(utterance);
            
            utterance.onstart = () => {
                showSpeaking(true);
            };
            
            utterance.onend = () => {
                speechQueue.shift(); // Remove finished utterance
                isSpeaking = false;
                
                // Speak next if queue has items
                if (speechQueue.length > 0) {
                    const nextUtterance = speechQueue[0];
                    isSpeaking = true;
                    synthesis.speak(nextUtterance);
                } else {
                    showSpeaking(false);
                }
            };

            utterance.onerror = (event) => {
                console.error('Speech error:', event);
                speechQueue.shift();
                isSpeaking = false;
                
                // Try next in queue
                if (speechQueue.length > 0) {
                    const nextUtterance = speechQueue[0];
                    isSpeaking = true;
                    synthesis.speak(nextUtterance);
                } else {
                    showSpeaking(false);
                }
            };

            // Only speak if nothing is currently speaking
            if (!isSpeaking) {
                isSpeaking = true;
                synthesis.speak(utterance);
            }
        }

        function loadVoices() {
            const voices = synthesis.getVoices();
            frenchVoices = voices.filter(voice => voice.lang.startsWith('fr'));
            
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';
            
            if (frenchVoices.length === 0) {
                voiceSelect.innerHTML = '<option value="">Aucune voix fran√ßaise</option>';
            } else {
                frenchVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.default || voice.lang === 'fr-FR') option.selected = true;
                    voiceSelect.appendChild(option);
                });
            }
        }

        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = loadVoices;
        }

        function startListening() {
            if (!recognition) {
                showError('Reconnaissance vocale non disponible');
                return;
            }

            // Reset buffers
            wordBuffer = [];
            segmentHistory = [];
            translationHistory = [];
            lastProcessedIndex = 0;
            speechQueue = []; // Clear speech queue
            isSpeaking = false;

            clearError();
            
            // Arr√™ter d'abord si d√©j√† en cours
            try {
                recognition.stop();
            } catch (e) {
                // Ignore si pas d√©j√† d√©marr√©
            }
            
            // Petit d√©lai avant de d√©marrer
            setTimeout(() => {
                isListening = true;
                updateStatus('üé§ D√©marrage...', true);
                
                try {
                    recognition.start();
                    updateStatus('üé§ √âcoute active...', true);
                    
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                } catch (error) {
                    console.error('Start error:', error);
                    if (error.message && error.message.includes('already started')) {
                        // D√©j√† d√©marr√©, c'est bon
                        updateStatus('üé§ √âcoute active...', true);
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                    } else {
                        showError('Erreur au d√©marrage: ' + error.message);
                        isListening = false;
                    }
                }
            }, 200);
        }

        function stopListening() {
            isListening = false;
            if (recognition) {
                recognition.stop();
            }
            synthesis.cancel();
            speechQueue = []; // Clear speech queue
            isSpeaking = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus('‚è∏Ô∏è Arr√™t√©', false);
            showProcessing(false);
        }

        function saveApiKey() {
            const apiKey = document.getElementById('deeplApiKey').value.trim();
            config.deeplApiKey = apiKey;
            localStorage.setItem('deeplApiKey', apiKey);
            updateApiStatus();
            
            if (apiKey) {
                showSuccess('‚úÖ Cl√© API sauvegard√©e !');
            } else {
                showSuccess('‚ÑπÔ∏è Mode gratuit activ√©');
            }
        }

        function updateApiStatus() {
            const apiConfig = document.getElementById('apiConfig');
            const statusIcon = document.getElementById('apiStatusIcon');
            const statusText = document.getElementById('apiStatusText');
            
            if (config.deeplApiKey) {
                apiConfig.classList.add('configured');
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = 'DeepL configur√©';
            } else {
                apiConfig.classList.remove('configured');
                statusIcon.textContent = 'üîë';
                statusText.textContent = 'Mode gratuit (qualit√© limit√©e)';
            }
        }

        function updateStats(charCount, latency) {
            stats.segmentsProcessed++;
            stats.totalChars += charCount;
            stats.latencies.push(latency);
            
            document.getElementById('segmentsProcessed').textContent = stats.segmentsProcessed;
            document.getElementById('charCount').textContent = stats.totalChars;
            
            const avgLatency = stats.latencies.reduce((a, b) => a + b, 0) / stats.latencies.length;
            document.getElementById('avgLatency').textContent = Math.round(avgLatency) + 'ms';
        }

        function updateSegmentCount() {
            document.getElementById('segmentCount').textContent = `${segmentHistory.length} segments`;
        }

        function updateTranslationCount() {
            document.getElementById('translationCount').textContent = `${translationHistory.length} traductions`;
        }

        function updateStatus(text, active) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            
            if (active) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        function showProcessing(show) {
            const indicator = document.getElementById('processingIndicator');
            if (show) {
                indicator.innerHTML = '<span class="processing-indicator"></span>';
            } else {
                indicator.innerHTML = '';
            }
        }

        function showSpeaking(show) {
            const indicator = document.getElementById('speakingIndicator');
            if (show) {
                indicator.innerHTML = '<span class="speaking-indicator"></span>';
            } else {
                indicator.innerHTML = '';
            }
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">‚ö†Ô∏è ${message}</div>`;
            setTimeout(clearError, 5000);
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function showSuccess(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message" style="background: #d1fae5; border-color: #10b981; color: #065f46;">${message}</div>`;
            setTimeout(clearError, 3000);
        }

        window.addEventListener('beforeunload', () => {
            stopListening();
        });
    </script>
</body>
</html>
